# Обзор AI Toolkit (Визуальная Сегментация)

Этот набор инструментов (`Toolkit`) предназначен для полного цикла разработки моделей **визуальной сегментации** (Mask R-CNN). Он позволяет пользователям без глубоких навыков программирования выполнять разметку данных, обучать модели и использовать их для анализа новых изображений.

## Требования к системе

- **Python:** 3.12 (обязательно)
- **GPU:** NVIDIA GPU с CUDA для ускорения обучения (опционально, но рекомендуется)
- **RAM:** Минимум 8 ГБ (рекомендуется 16+ ГБ)
- **Зависимости:** PyTorch, ttkbootstrap, albumentations, opencv-python (см. `requirements.txt`)

## Поддерживаемые форматы изображений

`.jpg`, `.jpeg`, `.png`, `.bmp`, `.tiff`, `.webp`

## Рабочий Процесс

Весь процесс разбит на 3 логические вкладки:

1.  **Создание датасета:** Разметка изображений (создание полигонов).
2.  **Обучение модели:** Обучение модели на размеченных данных.
3.  **Анализ:** Применение обученной модели к новым изображениям и цикл обратной связи.

## Горячие клавиши

| Клавиша           | Действие                         |
|-------------------|----------------------------------|
| `Ctrl+Z`          | Отменить последнее действие      |
| `Ctrl+Shift+Z`    | Повторить отмененное действие    |
| `Ctrl+Y`          | Повторить отмененное действие    |
| `Delete`          | Удалить выделенную аннотацию     |
| `Колесо мыши`     | Масштабирование изображения      |
| `Ср. кнопка мыши` | Панорамирование изображения      |


---

## Вкладка 1: Создание датасета

Эта вкладка предназначена для подготовки данных для обучения.

### Шаг 1: Выбор папки и разметка

1.  **Выбор папки:** Нажмите "Выбор папки с данными". Укажите папку, содержащую *только* изображения (`.jpg`, `.png` и т.д.), которые вы хотите разметить.
2.  **Управление классами:**
    * Справа создайте "Набор классов" (например, "Tomato_Detection").
    * Кликнув правой кнопкой мыши по списку, добавьте классы (например, "plant", "leaf", "defect").
3.  **Разметка:**
    * Выберите класс в списке справа.
    * Начните рисовать полигон (маску) вокруг объекта на изображении, кликая левой кнопкой мыши.
    * Завершите полигон, кликнув правой кнопкой мыши.
    * Используйте "Следующее" / "Предыдущее" для навигации.
    * Прогресс сохраняется автоматически (`autosave.json`).

### Шаг 2: Сохранение датасета

1.  **Путь сохранения:** Укажите папку, куда будет сохранен готовый датасет.
2.  **Валидация:** Укажите процент данных (например, 20%), который будет отложен для валидации.
3.  **Сохранить:** Нажмите "Сохранить датасет".

Программа автоматически создаст необходимую структуру папок (`images/`, `labels/`, `val_images/`, `val_labels/`) и `data.yaml`, готовый для обучения.

---

## Вкладка 2: Обучение модели

Здесь происходит обучение (или дообучение) модели.

1.  **Шаг 1: Выбор/Создание модели**
    * **Создать:** Создайте новую папку для модели (например, `models/My_Tomato_Model_v1`). В ней будет создан базовый `config.yaml`.
    * **Выбрать:** Выберите папку с существующей моделью (содержащую `config.yaml`).
2.  **Шаг 2: Выбор датасета (Train)**
    * Укажите папку с датасетом, созданным на Вкладке 1 (ту, что содержит `data.yaml`).
    * Классы из `data.yaml` будут автоматически загружены в конфиг модели.
3.  **Шаг 2.5: (Опционально) Валидационный датасет**
    * Вы можете указать *другую* папку с датасетом, которая будет использоваться *только* для валидации. Если оставить пустым, будут использоваться данные из `val_images/` основного датасета (из Шага 2).
4.  **Шаг 3-4: Настройка и Запуск**
    * Укажите параметры (Эпохи, Скорость обучения, Батч, Аугментация).
    * **Обучить с нуля:** Начинает обучение с весов ImageNet.
    * **Дообучить:** Загружает лучший сохраненный checkpoint (`best_model.pt`) из папки `runs` и продолжает обучение (полезно, если обучение было прервано или нужно "дотюнить" модель с меньшим LR).

Во время обучения в логах будет отображаться `Train Loss` (ошибка на обучении) и `Val Loss` (ошибка на новых данных). **`Val Loss` — главный показатель качества модели.**

---

## Вкладка 3: Анализ и дообучение

Применение обученной модели и "Цикл обратной связи" (Feedback Loop).

### Анализ

1.  **Шаг 1: Выбор модели:** Выберите папку с обученной моделью (ту, что содержит `runs/best_model.pt`). Модель загрузится автоматически. (Если вы только что закончили обучение на Вкладке 2, модель загрузится сама).
2.  **Настройки:** Установите диапазон уверенности. Модель покажет только те объекты, уверенность в которых находится *между* "Мин." (напр. 30%) и "Макс." (напр. 70%) порогами.
3.  **Загрузить фото:** Выберите одно изображение для анализа.
4.  **Анализировать:** Модель обработает фото, нарисует полигоны (маски) и выведет в лог **подсчет найденных классов** (например, `-> plant: 5`).

### Цикл обратной связи

Если вы видите, что модель ошиблась (пропустила объект или неверно определила класс), вы можете:

1.  **Скорректировать ответ:** Нажмите эту кнопку. Включится режим рисования.
2.  **Исправить:**
    * Нарисуйте новые полигоны (выбрав класс в диалоге).
    * Выделите существующий полигон и нажмите "Удалить выделенное".
    * Выделите полигон и нажмите "Назначить класс", чтобы изменить его класс.
3.  **Сохранить исправления:**
    * Нажмите "Сохранить исправления...".
    * Программа сохранит *только это* изображение и *вашу* (исправленную) разметку в папку `feedback_data`.
4.  **Дообучение:**
    * Вернитесь на "Вкладку 2".
    * В качестве "Шага 2: Выбор датасета" укажите папку `feedback_data`.
    * Нажмите "Дообучить модель". Модель улучшит свои знания на основе ваших исправлений.
